<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <h1 id="points">Points: 0</h1>
    <canvas id="myCanvas"></canvas>
    <script>
        let canvas = document.getElementById('myCanvas');
        let ctx = canvas.getContext('2d', { willReadFrequently: true });
        let isDrawing = false;
        let points = 0;
        let gommePositions = {}; // Tableau pour stocker les positions déjà gommées
        let surfaceTotale = canvas.width * canvas.height;
        let surfaceGaumeeTotal = 0; // Suivre la surface gommée totale

        function surfaceCercle(rayon) {
            return Math.PI * rayon * rayon;
        }

        function attribuerPoints(pourcentageGomme) {
            let pointsAttribues = 0;

            if (pourcentageGomme >= 100) {
                pointsAttribues = 50;
            } else if (pourcentageGomme >= 50) {
                pointsAttribues = 25;
            } else if (pourcentageGomme >= 25) {
                pointsAttribues = 5;
            }
            document.getElementById('points').innerText = "Points: " + pointsAttribues;
        }

        function gommer(x, y, rayon) {
            let keyX = Math.round(x); // Arrondir les coordonnées pour une correspondance précise
            let keyY = Math.round(y);

            // Récupérer la valeur de l'alpha du pixel à la position donnée
            let pixelData = ctx.getImageData(x, y, 1, 1).data;
            let alphaValue = pixelData[3];

            if (!gommePositions[keyX]) {
                gommePositions[keyX] = {};
            }

            if (!gommePositions[keyX][keyY] && alphaValue !== 0) {
                ctx.globalCompositeOperation = 'destination-out';
                ctx.beginPath();
                ctx.arc(x, y, rayon, 0, Math.PI * 2, true);
                ctx.fill();

                // Mettre à jour la surface gommée totale
                surfaceGaumeeTotal += surfaceCercle(rayon);

                // Calculer le pourcentage d'image effacée
                let pourcentageGomme = (surfaceGaumeeTotal / surfaceTotale);
                console.log("%" + pourcentageGomme)
                // Attribuer les points en fonction du pourcentage
                let pointsGagnes = attribuerPoints(pourcentageGomme);
                points += pointsGagnes;


                gommePositions[keyX][keyY] = true; // Marquer comme gommé
            }
        }

        let img = new Image();
        img.onload = function () {
            // Redimensionner le canvas en fonction de la taille de l'image
            canvas.width = img.width;
            canvas.height = img.height;
            // Dessiner l'image sur le canvas
            ctx.drawImage(img, 0, 0);
            // Réinitialiser la surface gommée totale
            surfaceGaumeeTotal = 0;
        };
        img.src = 'source/image/above_the_birds.png';

        // Ajout des écouteurs d'événements tactiles et de souris
        canvas.addEventListener('mousedown', function (e) {
            isDrawing = true;
            let rect = canvas.getBoundingClientRect();
            let x = e.clientX - rect.left;
            let y = e.clientY - rect.top;
            gommer(x, y, 20);
        });

        canvas.addEventListener('mousemove', function (e) {
            if (isDrawing) {

                let rect = canvas.getBoundingClientRect();
                let x = e.clientX - rect.left;
                let y = e.clientY - rect.top;
                gommer(x, y, 20);
            }
        });

        canvas.addEventListener('mouseup', function () {
            isDrawing = false;
        });

        canvas.addEventListener('touchstart', function (e) {
            isDrawing = true;
            let rect = canvas.getBoundingClientRect();
            let x = e.touches[0].clientX - rect.left;
            let y = e.touches[0].clientY - rect.top;
            gommer(x, y, 20);
        });

        canvas.addEventListener('touchmove', function (e) {
            if (isDrawing) {
                let rect = canvas.getBoundingClientRect();
                let x = e.touches[0].clientX - rect.left;
                let y = e.touches[0].clientY - rect.top;
                gommer(x, y, 20);
            }
        });

        canvas.addEventListener('touchend', function () {
            isDrawing = false;
        });

    </script>
</body>
</html>
